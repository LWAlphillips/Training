<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script>
// YOUR CORRECT CSV URL
const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRV7v_0mQWcqJI9ExD7lphRQDaHnyv65Tp_i2uDiBJOcxAJ5l6jXV1-WFFBKSU9YZErgLDkGB6nYmug/pub?output=csv';
const RECIPIENT_EMAIL = 'your-team@company.com'; // ← CHANGE TO REAL EMAIL

// ... (keep all your LINKS, ALL_TRAININGS, REQUIRED_TRAININGS, SUGGESTED_TRAININGS unchanged) ...

let records = [], topicMap = {}, employeeMap = {}, allTopics = new Set();
let allOverdue = [];

async function loadData() {
  document.getElementById('status').innerHTML = 'Fetching data...';
  try {
    const resp = await fetch(SHEET_URL + '&_=' + Date.now());
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    const text = await resp.text();

    // Use PapaParse – handles commas inside quotes properly
    const results = Papa.parse(text, {
      header: true,
      skipEmptyLines: true,
      transformHeader: h => h.trim().replace(/^"|"$/g, '')
    });

    records = results.data
      .filter(r => r['Employee Name']?.trim() && r['Topic']?.trim())
      .map(r => {
        // Clean up any lingering quotes
        Object.keys(r).forEach(k => r[k] = (r[k] || '').trim().replace(/^"|"$/g, ''));
        return r;
      });

    document.getElementById('status').innerHTML = `Loaded <strong>${records.length}</strong> records`;
    return records;
  } catch (err) {
    document.getElementById('status').innerHTML = `<span class="text-danger">Error: ${err.message}</span>`;
    console.error(err);
    return [];
  }
}

function parseTextDate(dateStr) {
  if (!dateStr) return 'N/A';
  // Handles "February 10, 2026" and "February 10 2026"
  const match = dateStr.match(/([A-Za-z]+)\s+(\d{1,2})[,\s]+(\d{4})/);
  if (match) {
    const [_, monthStr, day, year] = match;
    const months = {Jan:0,Feb:1,Mar:2,Apr:3,May:4,Jun:5,Jul:6,Aug:7,Sep:8,Oct:9,Nov:10,Dec:11};
    const month = months[monthStr.substring(0,3)] || 0;
    return new Date(year, month, day).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
  }
  const parts = dateStr.split('/');
  if (parts.length === 3) {
    return new Date(parts[2], parts[0]-1, parts[1]).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
  }
  return dateStr || 'N/A';
}

// ... (normalizeName, badge, exportPDF, openOutlookEmail, buildData, showAllOverdue, renderTopics, etc. – ALL UNCHANGED) ...

// At the very bottom, change the initial call:
buildData();
setInterval(buildData, 600000);
</script>
