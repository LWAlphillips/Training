<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>LWA Employee Training Record</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <style>
    body { background:#f4f6f9; font-family:system-ui, -apple-system, sans-serif; }
    .header-section { text-align: center; padding: 2.5rem 1rem 2rem; }
    .main-title { font-size: 2rem; font-weight: 700; color: #007bff; margin-bottom: 0.5rem; }
    .subtitle { color: #555; margin-bottom: 2rem; font-size: 1.1rem; }
    .badge-due { background:#28a745; color:#fff; font-weight:600; }
    .badge-over { background:#dc3545; color:#fff; font-weight:600; }
    .badge-comp { background:#6c757d; color:#fff; }
    .badge-norecord { background:#adb5bd; color:#fff; }
    table th { background:#343a40; color:#fff; font-weight:600; }
    .card { box-shadow:0 4px 12px rgba(0,0,0,.07); border:none; border-radius:12px; }
    .section-header { background:#e9ecef; font-weight:bold; padding:8px 12px; border-radius:8px; margin:20px 0 10px; }
  </style>
</head>
<body>
<div class="container-fluid">
  <div class="header-section">
    <h1 class="main-title">My LWA Training Record</h1>
    <p class="subtitle lead">Select your name below to view your current training status</p>
    <div class="d-flex justify-content-center mb-3">
      <select id="employeeSelect" class="form-select w-auto" style="min-width:300px; max-width:100%;">
        <option value="">— Select your name —</option>
      </select>
    </div>
    <div class="text-muted small" id="status">Loading training data...</div>
  </div>
  <div class="card mx-3 mx-md-5 mb-5 shadow d-none" id="detailPane">
    <div class="card-body p-4">
      <div class="text-center py-5">
        <p class="fs-4 text-muted">Select your name above to view your training record</p>
      </div>
    </div>
  </div>
</div>

<script>
// SHARED CSV URL
const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRV7v_0mQWcqJI9ExD7lphRQDaHnyv65Tp_i2uDiBJOcxAJ5l6jXV1-WFFBKSU9YZErgLDkGB6nYmug/pub?output=csv';

const LINKS = {
  "Fall Protection": "https://www.surveymonkey.com/r/LWAFallProtectionQuiz",
  "Hazard Communication (HazCom/GHS)": "https://www.surveymonkey.com/r/LWAHazCom",
  "Indoor Heat Illness Prevention": "https://www.surveymonkey.com/r/LWAIndoorHeatIllness",
  "Outdoor Heat Illness Prevention": "https://www.surveymonkey.com/r/LWAHeatIllnessQuiz",
  "Wildfire Smoke Prevention": "https://www.surveymonkey.com/r/LWAWildFireTraining",
  "Workplace Violence Prevention": "https://www.surveymonkey.com/r/LWAWVPP"
};

// REQUIRED TRAININGS
const REQUIRED_TRAININGS = [
  "Fall Protection",
  "Hazard Communication (HazCom/GHS)",
  "Indoor Heat Illness Prevention",
  "Outdoor Heat Illness Prevention",
  "Wildfire Smoke Prevention",
  "Workplace Violence Prevention"
];

// SUGGESTED TRAININGS
const SUGGESTED_TRAININGS = [
  "Confined Space",
  "Forklift Training",
  "Mobile Elevated Work Platform",
  "First Aid/CPR/AED",
  "Harassment & Discrimination Training",
  "Workplace Violence Property Assessment"
];

let employeeMap = {};

async function loadData() {
  document.getElementById('status').innerHTML = 'Loading training data...';
  try {
    const resp = await fetch(SHEET_URL + '&_=' + Date.now());
    if (!resp.ok) throw new Error('Failed to load');
    const text = await resp.text();
    const lines = text.split('\n').map(l => l.trim()).filter(Boolean);
    if (lines.length < 2) throw new Error('No data');
    const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
    const records = lines.slice(1).map(line => {
      const vals = line.split(',').map(v => v.trim().replace(/^"|"$/g, ''));
      const rec = {};
      headers.forEach((h, i) => rec[h] = vals[i] || '');
      return rec;
    }).filter(r => r['Employee Name'] && r['Topic']);

    employeeMap = {};
    records.forEach(r => {
      let topic = r['Topic']?.trim() || '';

      // Normalization
      if (topic === "Fall Protection Awareness") topic = "Fall Protection";
      if (topic === "Wildfire Protection") topic = "Wildfire Smoke Prevention";
      if (topic === "Heat Illness Prevention" && !topic.includes("(Indoor)") && !topic.includes("(Outdoor)")) topic = "Indoor Heat Illness Prevention";

      const orig = r['Employee Name']?.trim() || '';
      const norm = normalizeName(orig);
      if (!norm || !topic) return;
      if (!employeeMap[norm]) employeeMap[norm] = { original: orig, records: {} };

      const existing = employeeMap[norm].records[topic];
      const newDays = parseInt(r['Days Remaining'] || '0', 10);
      const existingDays = existing ? parseInt(existing['Days Remaining'] || '0', 10) : 0;

      // Prefer higher Days Remaining (newer training)
      if (!existing || newDays > existingDays) {
        employeeMap[norm].records[topic] = r;
      }
    });

    populateEmployeeDropdown();
    document.getElementById('status').innerHTML = '';
  } catch (err) {
    document.getElementById('status').innerHTML = '<span class="text-danger">Error loading data — please try again later</span>';
  }
}

// (normalizeName, parseTextDate, badge, populateEmployeeDropdown, exportPDF, showEmployeeDetail unchanged from previous)

loadData();
</script>
</body>
</html>
