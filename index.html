<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>LWA Training Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style>
    body { background:#f4f6f9; font-family:system-ui; transition:all .3s; }
    body.dark { background:#121212; color:#e0e0e0; }
    body.dark .card { background:#1e1e1e; color:#e0e0e0; border:1px solid #333; }
    body.dark table th { background:#343a40; color:#fff; }
    body.dark .table { color:#e0e0e0; }
    body.dark .table-hover tbody tr:hover { background:#2c2c2c; }
    body.dark .list-group-item { background:#2c2c2c!important; color:#e0e0e0!important; border-color:#444!important; }
    body.dark .list-group-item:hover { background:#3a3a3a!important; }
    .card { box-shadow:0 4px 12px rgba(0,0,0,.07); border:none; border-radius:12px; }
    .badge-due { background:#28a745; color:#fff; font-weight:600; }
    .badge-over { background:#dc3545; color:#fff; font-weight:600; }
    .badge-comp { background:#6c757d; color:#fff; }
    .badge-norecord { background:#adb5bd; color:#fff; }
    .badge-expiring { background:#ffc107; color:#000; font-weight:600; }
    table th { background:#343a40; color:#fff; font-weight:600; }
    .overdue-banner { background:#dc3545; color:#fff; padding:12px; border-radius:8px; margin-bottom:20px; }
    body.dark .overdue-banner { background:#bb2d3b; }
    .controls-row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; justify-content:center; }
    .control-input { width:240px!important; max-width:100%; }
    .refresh-btn { white-space:nowrap; }
    .section-header { background:#e9ecef; font-weight:bold; padding:8px 12px; border-radius:8px; margin:20px 0 10px; }
    body.dark .section-header { background:#2c2c2c; }
    @media(max-width:991px){
      .order-mobile-1 { order:1; }
      .order-mobile-2 { order:2; }
      #topicList { max-height:50vh; }
    }
    @media (max-width: 767px) {
      .table-responsive { overflow-x: hidden; }
      table { display: none; }
      .training-card { background: white; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 1rem; padding: 1rem; }
      body.dark .training-card { background: #222; }
      .training-card h5 { margin: 0 0 0.75rem; font-size: 1.1rem; }
      .training-card .detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.9rem; }
      .training-card .detail-grid > div { display: flex; flex-direction: column; }
      .training-card .detail-grid .label { font-weight: 600; color: #555; font-size: 0.8rem; }
      body.dark .training-card .label { color: #aaa; }
    }
  </style>
</head>
<body class="p-3">

<div class="container-fluid">
  <div id="overdueBanner" class="overdue-banner d-none">
    <strong>Overdue Alert:</strong> <span id="overdueCount"></span> trainings overdue/due soon/missing for <span id="overdueEmps"></span> employees.
  </div>

  <div class="card mb-4">
    <div class="card-body text-center py-4">
      <h1 class="display-5 fw-bold text-primary">LWA Training Tracker</h1>
      <p class="lead">Live from Google Sheets</p>
      <div class="status-bar text-muted" id="status">Initializing...</div>
      <div class="text-muted small mt-1" id="lastUpdated">Last loaded: —</div>
      <div class="controls-row mt-3">
        <input type="text" id="topicSearch" class="form-control form-control-sm control-input" placeholder="Search topics…">
        <select id="roleFilter" class="form-select form-select-sm control-input">
          <option value="">— All Roles —</option>
        </select>
        <select id="employeeSelect" class="form-select form-select-sm control-input">
          <option value="">— Jump to employee —</option>
        </select>
        <button class="btn btn-outline-primary btn-sm refresh-btn" onclick="buildData()">Refresh</button>
        <button class="btn btn-outline-danger btn-sm" onclick="showAllOverdue()">View All Overdue</button>
        <div class="form-check form-switch ms-2">
          <input class="form-check-input" type="checkbox" id="darkModeToggle">
          <label class="form-check-label text-muted small" for="darkModeToggle">Dark</label>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-lg-8 order-mobile-1 mb-4">
      <div id="detailPane" class="card h-100">
        <div class="card-body d-flex align-items-center justify-content-center text-muted">
          <p class="mb-0 fs-5">Loading data... Select a topic or employee</p>
        </div>
      </div>
    </div>
    <div class="col-lg-4 order-mobile-2 mb-4">
      <div class="card h-100">
        <div class="card-header bg-primary text-white"><strong>Training Topics</strong></div>
        <div class="card-body p-0">
          <div id="topicList" class="list-group list-group-flush" style="max-height:70vh;overflow-y:auto"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRV7v_0mQWcqJI9ExD7lphRQDaHnyv65Tp_i2uDiBJOcxAJ5l6jXV1-WFFBKSU9YZErgLDkGB6nYmug/pub?output=csv';

const TRAINING_RULES = {
  "Fire Prevention and Extinguishers": "All Required",
  "Workplace Violence Prevention": "All Required",
  "Fall Protection": "Field Required",
  "Heat Illness Prevention (Indoor)": "Field Required",
  "Heat Illness Prevention (Outdoor)": "Field Required",
  "Personal Protective Equipment": "Field Required",
  "Silica Awareness Training": "Field Required",
  "Wildfire Protection": "Field Required",
  "First Aid/CPR/AED": "Foreman",
  "Intro to First Aid": "Foreman",
  "OSHA 30 Certificate": "Optional",
  "Certified Rigger and Signaler": "Job Dependent",
  "SpecialtyConfined Space": "Job Dependent",
  "Confined Space": "Job Dependent",
  "Forklift Training": "Job Dependent",
  "Mobile Elevated Work Platform": "Job Dependent",
  "NCCO Crane Operations": "Job Dependent",
  "Part 46 New Miner": "Job Dependent",
  "Part 46 Refresher": "Job Dependent",
  "Respiratory Fit Testing": "Job Dependent",
  "Respiratory Medical Questionnare": "Job Dependent",
  "Silica Dust Exposure": "Job Dependent"
};

function isRequiredForRole(topic, role) {
  const rule = TRAINING_RULES[topic];
  if (!rule) return false;
  const r = (role || '').trim().toLowerCase();
  if (rule === "All Required") return true;
  if (rule === "Field Required") return r === "field" || r === "foreman";
  if (rule === "Foreman") return r === "foreman";
  if (rule === "Office") return r === "office";
  return false;
}

let records = [], topicMap = {}, employeeMap = {}, allOverdue = [];

async function loadData() {
  const statusEl = document.getElementById('status');
  if (!statusEl) return console.error("Status element missing");
  statusEl.innerHTML = 'Fetching data...';
  try {
    const resp = await fetch(SHEET_URL + '&_=' + Date.now());
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    const text = await resp.text();
    const parsed = Papa.parse(text, {
      header: true,
      skipEmptyLines: true,
      transformHeader: h => h.trim().replace(/^"|"$/g, ''),
      transform: v => v.trim().replace(/^"|"$/g, '')
    });
    records = parsed.data.filter(r => r['Employee Name'] && r['Topic']);
    statusEl.innerHTML = `Loaded ${records.length} records`;
    updateLastUpdated();
    return records;
  } catch (err) {
    console.error("Load error:", err);
    statusEl.innerHTML = `<span class="text-danger">Error: ${err.message}</span>`;
    return [];
  }
}

function updateLastUpdated() {
  const el = document.getElementById('lastUpdated');
  if (el) el.textContent = `Last loaded: ${new Date().toLocaleString('en-US', { dateStyle: 'medium', timeStyle: 'short' })}`;
}

function parseTextDate(dateStr) {
  if (!dateStr) return 'N/A';
  const months = {Jan:0,Feb:1,Mar:2,Apr:3,May:4,Jun:5,Jul:6,Aug:7,Sep:8,Oct:9,Nov:10,Dec:11};
  const match = dateStr.match(/(\w{3})\s+(\d{1,2}),\s+(\d{4})/);
  if (match) {
    const [_, m, d, y] = match;
    return new Date(y, months[m], d).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
  }
  const parts = dateStr.split('/');
  if (parts.length === 3) {
    const m = parseInt(parts[0],10)-1, d = parseInt(parts[1],10), y = parseInt(parts[2],10);
    if (y > 1900 && !isNaN(m) && !isNaN(d)) return new Date(y, m, d).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
  }
  return dateStr || 'N/A';
}

function normalizeName(name) {
  return name?.replace(/Perira/gi, 'Pereira')
    .replace(/Silviera/gi, 'Silveira')
    .replace(/[^\w\s]/g, '')
    .trim()
    .toLowerCase()
    .replace(/\s+/g, ' ') || '';
}

function badge(r) {
  const s = r?.['Status'] || '';
  const daysStr = r?.['Days Remaining'] || '';
  const days = parseInt(daysStr, 10);
  let cls = 'bg-secondary', txt = s || '—';
  if (s === 'Completed') { cls = 'badge-comp'; txt = 'Completed'; }
  else if (s === 'Not Due') { cls = 'badge-due'; txt = 'Not Due' + (daysStr ? ` (${daysStr}d)` : ''); }
  else if (s === 'Overdue') { cls = 'badge-over'; txt = 'Overdue' + (daysStr ? ` (${daysStr}d)` : ''); }
  else if (s === 'Due Soon') { cls = 'badge-expiring'; txt = 'Due Soon' + (daysStr ? ` (${daysStr}d)` : ''); }
  return `<span class="badge ${cls}">${txt}</span>`;
}

function daysLeftStyle(daysStr) {
  if (!daysStr || daysStr === 'N/A') return '';
  const days = parseInt(daysStr, 10);
  if (isNaN(days)) return '';
  if (days <= 0) return 'text-danger fw-bold';
  if (days <= 30) return 'text-warning fw-bold';
  return 'text-success';
}

async function buildData() {
  console.log("buildData started");
  records = await loadData();
  if (!records.length) {
    console.warn("No records loaded");
    return;
  }

  topicMap = {};
  employeeMap = {};
  allOverdue = [];
  let overdueCount = 0;
  const overdueEmps = new Set();
  const uniqueRoles = new Set();

  records.forEach(r => {
    let topic = r['Topic']?.trim() || '';
    if (topic === "Fall Protection Awareness") topic = "Fall Protection";
    if (topic === "SpecialtyConfined Space") topic = "Confined Space";

    const origName = r['Employee Name']?.trim() || '';
    const normName = normalizeName(origName);
    const role = (r['Role'] || '').trim();

    if (role) uniqueRoles.add(role);

    if (!normName || !topic) return;

    if (!employeeMap[normName]) employeeMap[normName] = { original: origName, role, records: {} };
    employeeMap[normName].records[topic] = r;

    if (!topicMap[topic]) topicMap[topic] = [];
    topicMap[topic].push({ ...r, 'Employee Name': origName });

    if (['Overdue', 'Due Soon'].includes(r['Status'] || '')) {
      overdueCount++;
      overdueEmps.add(normName);
      allOverdue.push({ employee: origName, topic, ...r });
    }
  });

  // Flag missing required trainings
  Object.values(employeeMap).forEach(emp => {
    Object.keys(TRAINING_RULES).forEach(t => {
      if (isRequiredForRole(t, emp.role) && !emp.records[t]) {
        overdueCount++;
        overdueEmps.add(normalizeName(emp.original));
        allOverdue.push({ employee: emp.original, topic: t, 'Days Remaining': 'N/A', Status: 'No Record' });
      }
    });
  });

  const overdueEl = document.getElementById('overdueCount');
  const empsEl = document.getElementById('overdueEmps');
  const bannerEl = document.getElementById('overdueBanner');
  if (overdueEl) overdueEl.textContent = overdueCount;
  if (empsEl) empsEl.textContent = overdueEmps.size;
  if (bannerEl) bannerEl.classList.toggle('d-none', overdueCount === 0);

  // Populate role filter
  const roleSelect = document.getElementById('roleFilter');
  if (roleSelect) {
    const prev = roleSelect.value;
    roleSelect.innerHTML = '<option value="">— All Roles —</option>';
    [...uniqueRoles].sort().forEach(role => {
      const opt = document.createElement('option');
      opt.value = role.toLowerCase();
      opt.textContent = role.charAt(0).toUpperCase() + role.slice(1).toLowerCase();
      roleSelect.appendChild(opt);
    });
    if (prev) {
      const lower = prev.toLowerCase();
      const match = Array.from(roleSelect.options).find(o => o.value === lower);
      if (match) roleSelect.value = match.value;
    }
  }

  renderTopics(document.getElementById('topicSearch')?.value.trim() || '');
  populateEmployeeDropdown();

  console.log("buildData finished - employees:", Object.keys(employeeMap).length);
}

function renderTopics(filter = '') {
  const el = document.getElementById('topicList');
  if (!el) return;
  el.innerHTML = '';
  const topics = Object.keys(topicMap).sort();
  topics.forEach(t => {
    if (filter && !t.toLowerCase().includes(filter.toLowerCase())) return;
    const count = topicMap[t]?.length || 0;
    const item = document.createElement('a');
    item.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
    item.innerHTML = `<span>${t}</span> <span class="badge bg-primary rounded-pill">${count}</span>`;
    item.onclick = () => showTopicDetail(t);
    el.appendChild(item);
  });
}

function populateEmployeeDropdown() {
  const sel = document.getElementById('employeeSelect');
  const roleEl = document.getElementById('roleFilter');
  if (!sel || !roleEl) return console.error("Dropdowns missing");

  const selectedRole = roleEl.value.trim().toLowerCase();
  console.log("Populating employees - selected role:", selectedRole || "[All]");

  sel.innerHTML = '<option value="">— Jump to employee —</option>';

  const filtered = Object.keys(employeeMap)
    .filter(norm => {
      const empRole = (employeeMap[norm].role || '').trim().toLowerCase();
      return !selectedRole || empRole === selectedRole;
    })
    .sort((a,b) => employeeMap[a].original.localeCompare(employeeMap[b].original));

  filtered.forEach(norm => {
    const opt = document.createElement('option');
    opt.value = norm;
    opt.textContent = employeeMap[norm].original;
    sel.appendChild(opt);
  });

  if (filtered.length === 0 && selectedRole) {
    const opt = document.createElement('option');
    opt.disabled = true;
    opt.textContent = `(No employees for this role)`;
    sel.appendChild(opt);
  }

  sel.onchange = e => { if (e.target.value) showEmployeeDetail(e.target.value); };
}

// Placeholder for your other functions - add them here
function showTopicDetail(topic) {
  // Your existing code for showing topic details
  console.log("Showing topic:", topic);
  // ... add your full implementation ...
}

function showEmployeeDetail(norm) {
  // Your existing code
  console.log("Showing employee:", norm);
  // ... add your full implementation ...
}

function showAllOverdue() {
  // Your existing code
  console.log("Showing all overdue");
  // ... add your full implementation ...
}

function exportPDF() {
  // Your existing code
  console.log("Export PDF called");
}

function openOutlookEmail(norm) {
  // Your existing code
  console.log("Email for:", norm);
}

// Dark mode toggle (can stay global)
document.getElementById('darkModeToggle')?.addEventListener('change', e => {
  document.body.classList.toggle('dark', e.target.checked);
  localStorage.setItem('darkMode', e.target.checked ? 'true' : 'false');
});
if (localStorage.getItem('darkMode') === 'true') {
  document.getElementById('darkModeToggle')?.checked = true;
  document.body.classList.add('dark');
}

// ──────────────────────────────────────────────
// WAIT FOR DOM TO BE READY BEFORE STARTING
// ──────────────────────────────────────────────
document.addEventListener('DOMContentLoaded', () => {
  console.log("DOM ready - starting app");

  // Attach event listeners
  document.getElementById('topicSearch')?.addEventListener('input', e => renderTopics(e.target.value.trim()));

  document.getElementById('roleFilter')?.addEventListener('change', () => {
    console.log("Role filter changed to:", document.getElementById('roleFilter').value);
    populateEmployeeDropdown();
  });

  // Start loading data
  buildData().catch(err => {
    console.error("Initial load failed:", err);
    const status = document.getElementById('status');
    if (status) status.innerHTML = `<span class="text-danger">Critical error: ${err.message}</span>`;
  });

  setInterval(buildData, 900000);
});
</script>
</body>
</html>
