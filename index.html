<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>LWA Training Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <style>
    body { background:#f4f6f9; font-family:system-ui; transition:all .3s; }
    body.dark { background:#121212; color:#e0e0e0; }
    body.dark .card { background:#1e1e1e; color:#e0e0e0; border:1px solid #333; }
    body.dark table th { background:#343a40; color:#fff; }
    body.dark .table { color:#e0e0e0; }
    body.dark .table-hover tbody tr:hover { background:#2c2c2c; }
    body.dark .list-group-item { background:#2c2c2c!important; color:#e0e0e0!important; border-color:#444!important; }
    body.dark .list-group-item:hover { background:#3a3a3a!important; }
    .card { box-shadow:0 4px 12px rgba(0,0,0,.07); border:none; border-radius:12px; }
    .badge-due { background:#28a745; color:#fff; }
    .badge-over { background:#dc3545; color:#fff; }
    .badge-comp { background:#6c757d; color:#fff; }
    .badge-notify { background:#ffc107; color:#000; }
    .badge-norecord { background:#6c757d; color:#fff; }
    .list-group-item:hover { background:#e9ecef; cursor:pointer; }
    table th { background:#343a40; color:#fff; }
    .overdue-banner { background:#dc3545; color:#fff; padding:10px; border-radius:8px; margin-bottom:20px; }
    body.dark .overdue-banner { background:#bb2d3b; }
    .controls-row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; justify-content:center; }
    .control-input { width:240px!important; max-width:100%; }
    .refresh-btn { white-space:nowrap; }
    @media(max-width:991px){
      .order-mobile-1 { order:1; }
      .order-mobile-2 { order:2; }
      #topicList { max-height:50vh; }
    }
    .training-link { color:#007bff; text-decoration:underline; }
    body.dark .training-link { color:#4dabf7; }
    .schedule-training { color:inherit; font-weight:500; }
    body.dark .schedule-training { color:#ccc; }
  </style>
</head>
<body class="p-3">
<div class="container-fluid">
  <div id="overdueBanner" class="overdue-banner d-none">
    <strong>Overdue Alert:</strong> <span id="overdueCount"></span> trainings overdue for <span id="overdueEmps"></span> employees.
  </div>
  <div class="card mb-4"><div class="card-body text-center py-4">
    <h1 class="display-5 fw-bold text-primary">LWA Training Tracker</h1>
    <p class="lead">Live from Google Sheets — Click to explore</p>
    <div class="status-bar text-muted" id="status">Loading...</div>
    <div class="controls-row mt-3">
      <input type="text" id="topicSearch" class="form-control form-control-sm control-input" placeholder="Search topics…">
      <select id="employeeSelect" class="form-select form-select-sm control-input"><option value="">— Jump to employee —</option></select>
      <button class="btn btn-outline-primary btn-sm refresh-btn" onclick="buildData()">Refresh</button>
      <div class="form-check form-switch ms-2">
        <input class="form-check-input" type="checkbox" id="darkModeToggle">
        <label class="form-check-label text-muted small" for="darkModeToggle">Dark</label>
      </div>
    </div>
  </div></div>
  <div class="row">
    <div class="col-lg-8 order-mobile-1 mb-4">
      <div id="detailPane" class="card h-100">
        <div class="card-body d-flex align-items-center justify-content-center text-muted">
          <p class="mb-0 fs-5">Click a topic or employee</p>
        </div>
      </div>
    </div>
    <div class="col-lg-4 order-mobile-2 mb-4">
      <div class="card h-100">
        <div class="card-header bg-primary text-white"><strong>Training Topics</strong></div>
        <div class="card-body p-0">
          <div id="topicList" class="list-group list-group-flush" style="max-height:70vh;overflow-y:auto"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// UPDATE THIS TO YOUR LONGFORMAT CSV URL ONCE SCRIPT FINISHES
const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ5QXu7Ex4SrxKH0k3wHYu_V1zP2GHSDglUCu-y3-ovyMimoSsixRd7VqYxLGMMoA7Yfr74LNv7hp5x/pub?output=csv';

const RECIPIENT_EMAIL = 'your-team@company.com'; // ← CHANGE TO REAL EMAIL

const LINKS = {
  "Fall Protection": "https://www.surveymonkey.com/r/LWAFallProtectionQuiz",
  "Heat Illness Prevention": "https://www.surveymonkey.com/r/LWAIndoorHeatIllness",
  "Personal Protective Equipment": "https://www.surveymonkey.com/r/LWAPPEQuiz",
  "Silica Awareness Training": "https://www.surveymonkey.com/r/LWASilicaDustExposure",
  "Silica Dust Exposure": "https://www.surveymonkey.com/r/LWASilicaDustExposure",
  "Workplace Violence Prevention": "https://www.surveymonkey.com/r/LWAWVPP",
  "Fire Prevention and Extinguishers": "https://www.surveymonkey.com/r/LWABasicFirePreventionQuiz"
  // Add more as you create them
};

// COMPLETE LIST OF ALL TRAININGS (required + others) – exact from your sheet
const REQUIRED_TOPICS = [
  "Certified Rigger and Signaler",
  "Confined Space",
  "Fall Protection",
  "Fire Prevention and Extinguishers",
  "First Aid/CPR/AED",
  "Forklift Training",
  "Heat Illness Prevention",
  "Intro to First Aid",
  "Mobile Elevated Work Platform",
  "NCCO Crane Operations",
  "OSHA 30 Certificate",
  "Part 46 New Miner",
  "Part 46 Refresher",
  "Personal Protective Equipment",
  "Respiratory Fit Testing",
  "Respiratory Medical Questionnare",
  "Silica Awareness Training",
  "Silica Dust Exposure",
  "Workplace Violence Prevention"
];

let records = [], topicMap = {}, employeeMap = {}, allTopics = new Set();

// ... (rest of the script unchanged up to showEmployeeDetail)

function showEmployeeDetail(norm) {
  const emp = employeeMap[norm];
  if (!emp) return;
  const name = emp.original;
  const over = Object.entries(emp.records).filter(([,r]) => r['Status'] === 'Overdue').length;
  let html = `<div class="card-body"><div class="d-flex justify-content-between"><h4>${name}</h4><div><button class="btn btn-success btn-sm" onclick="exportPDF()">PDF</button><button class="btn btn-primary btn-sm" onclick="openOutlookEmail('${norm}')">Send Email</button></div></div><p class="text-muted">All trainings | Overdues: ${over}</p><div class="table-responsive"><table class="table table-sm table-hover"><thead><tr><th>Topic</th><th>Training Date</th><th>Completion Date</th><th>Expiration Date</th><th>Days Remaining</th><th>Status</th></tr></thead><tbody>`;
  
  // Use the full REQUIRED_TOPICS list so every training always appears
  REQUIRED_TOPICS.forEach(topic => {
    const r = emp.records[topic];
    let link = LINKS[topic] || Object.keys(LINKS).find(k => topic.includes(k) || k.includes(topic));
    const finalLink = link ? LINKS[link] : '';
    const cell = finalLink ? `<a href="${finalLink}" target="_blank" class="training-link">${topic}</a>` : topic;
    if (r) {
      html += `<tr><td>${cell}</td><td>${parseTextDate(r['Training Date'])}</td><td>${parseTextDate(r['Completion Date'])}</td><td>${parseTextDate(r['Expiration Date'])}</td><td>${r['Days Remaining'] || '-'}</td><td>${badge(r)}</td></tr>`;
    } else {
      html += `<tr class="table-secondary"><td>${cell}</td><td colspan="5"><span class="badge badge-norecord">No Record</span></td></tr>`;
    }
  });
  
  html += `</tbody></table></div></div>`;
  document.getElementById('detailPane').innerHTML = html;
}

// ... (rest of script exactly as before: dark mode, buildData(), etc.)

buildData();
setInterval(buildData, 600000);
</script>
</body>
</html>
