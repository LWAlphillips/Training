<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>LWA Training Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <style>
    body { background:#f4f6f9; font-family:system-ui; transition:all .3s; }
    body.dark { background:#121212; color:#e0e0e0; }
    body.dark .card { background:#1e1e1e; color:#e0e0e0; border:1px solid #333; }
    body.dark table th { background:#343a40; color:#fff; }
    body.dark .table { color:#e0e0e0; }
    body.dark .table-hover tbody tr:hover { background:#2c2c2c; }
    body.dark .list-group-item { background:#2c2c2c!important; color:#e0e0e0!important; border-color:#444!important; }
    body.dark .list-group-item:hover { background:#3a3a3a!important; }
    .card { box-shadow:0 4px 12px rgba(0,0,0,.07); border:none; border-radius:12px; }
    .badge-due { background:#28a745; color:#fff; }
    .badge-over { background:#dc3545; color:#fff; }
    .badge-comp { background:#6c757d; color:#fff; }
    .badge-notify { background:#ffc107; color:#000; }
    .badge-norecord { background:#6c757d; color:#fff; }
    .list-group-item:hover { background:#e9ecef; cursor:pointer; }
    table th { background:#343a40; color:#fff; }
    .overdue-banner { background:#dc3545; color:#fff; padding:10px; border-radius:8px; margin-bottom:20px; }
    body.dark .overdue-banner { background:#bb2d3b; }
    .controls-row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; justify-content:center; }
    .control-input { width:240px!important; max-width:100%; }
    .refresh-btn { white-space:nowrap; }
    .section-header { background:#e9ecef; font-weight:bold; padding:8px 12px; border-radius:8px; margin:20px 0 10px; }
    body.dark .section-header { background:#2c2c2c; }
    @media(max-width:991px){
      .order-mobile-1 { order:1; }
      .order-mobile-2 { order:2; }
      #topicList { max-height:50vh; }
    }
    .schedule-training { color:inherit; font-weight:500; }
    body.dark .schedule-training { color:#ccc; }
  </style>
</head>
<body class="p-3">
<div class="container-fluid">
  <div id="overdueBanner" class="overdue-banner d-none">
    <strong>Overdue Alert:</strong> <span id="overdueCount"></span> trainings overdue for <span id="overdueEmps"></span> employees.
  </div>
  <div class="card mb-4"><div class="card-body text-center py-4">
    <h1 class="display-5 fw-bold text-primary">LWA Training Tracker</h1>
    <p class="lead">Live from Google Sheets — Click to explore</p>
    <div class="status-bar text-muted" id="status">Loading...</div>
    <div class="controls-row mt-3">
      <input type="text" id="topicSearch" class="form-control form-control-sm control-input" placeholder="Search topics…">
      <select id="employeeSelect" class="form-select form-select-sm control-input"><option value="">— Jump to employee —</option></select>
      <button class="btn btn-outline-primary btn-sm refresh-btn" onclick="buildData()">Refresh</button>
      <div class="form-check form-switch ms-2">
        <input class="form-check-input" type="checkbox" id="darkModeToggle">
        <label class="form-check-label text-muted small" for="darkModeToggle">Dark</label>
      </div>
    </div>
  </div></div>
  <div class="row">
    <div class="col-lg-8 order-mobile-1 mb-4">
      <div id="detailPane" class="card h-100">
        <div class="card-body d-flex align-items-center justify-content-center text-muted">
          <p class="mb-0 fs-5">Click a topic or employee</p>
        </div>
      </div>
    </div>
    <div class="col-lg-4 order-mobile-2 mb-4">
      <div class="card h-100">
        <div class="card-header bg-primary text-white"><strong>Training Topics</strong></div>
        <div class="card-body p-0">
          <div id="topicList" class="list-group list-group-flush" style="max-height:70vh;overflow-y:auto"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// YOUR CLEAN CSV URL
const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRV7v_0mQWcqJI9ExD7lphRQDaHnyv65Tp_i2uDiBJOcxAJ5l6jXV1-WFFBKSU9YZErgLDkGB6nYmug/pub?output=csv';

const RECIPIENT_EMAIL = 'your-team@company.com'; // ← CHANGE TO REAL EMAIL

const LINKS = {
  "Fall Protection Awareness": "https://www.surveymonkey.com/r/LWAFallProtectionQuiz",
  "Hazard Communication (HazCom/GHS)": "https://www.surveymonkey.com/r/LWAHazCom",
  "Indoor Heat Illness Prevention": "https://www.surveymonkey.com/r/LWAIndoorHeatIllness",
  "Outdoor Heat Illness Prevention": "https://www.surveymonkey.com/r/LWAHeatIllnessQuiz",
  "Wildfire Smoke Prevention": "https://www.surveymonkey.com/r/LWAWildFireTraining",
  "Workplace Violence Prevention": "https://www.surveymonkey.com/r/LWAWVPP"
  // Add more as you create them
};

// ALL TRAININGS FOR SIDEBAR (shows all, even with 0 records)
const ALL_TRAININGS = [
  "40-Hour Hazwoper",
  "Air Products- Martinez Safety Indoct",
  "Andeaver Martinez Site Orientation",
  "CRIS Certificate",
  "Certified General Electrician",
  "Certified Rigger and Signaler",
  "Chemical Hazard Safety",
  "Confined Space",
  "Electrical Safety Awareness",
  "Fall Protection",
  "Fall Protection Awareness",
  "Fire Prevention and Extinguishers",
  "First Aid/CPR/AED",
  "Forklift Training",
  "Hazard Communication (HazCom/GHS)",
  "Heat Illness Prevention (Indoor)",
  "Heat Illness Prevention (Outdoor)",
  "Indoor Heat Illness Prevention",
  "Outdoor Heat Illness Prevention",
  "Intro to First Aid",
  "LOTO",
  "MEWP Fall Protection",
  "Machine Safe Guarding",
  "Mobile Elevated Work Platform",
  "NCCO Crane Operations",
  "Northern California RSO",
  "OSCA Card",
  "OSHA 10 Certificate",
  "OSHA 30 Certificate",
  "OSHA 500 Certificate",
  "OSHA 510 Certificate",
  "PG&E SAFE 0101 Training",
  "Part 46 New Miner",
  "Part 46 Refresher",
  "Part 48 New Miner",
  "Part 48 Refresher",
  "Personal Protective Equipment",
  "Respiratory Fit Testing",
  "Respiratory Medical Questionnare",
  "Shell Martinez Site Specific",
  "Silica Awareness Training",
  "Tesoro Martinez CA Site Specific",
  "Valley Fever Awareness",
  "Workplace Violence Prevention",
  "Harassment & Discrimination Training",
  "Workplace Violence Property Assessment",
  "Wildfire Smoke Prevention"
];

// REQUIRED TRAININGS – always shown in employee view, email for missing OR overdue
const REQUIRED_TRAININGS = [
  "Fall Protection Awareness",
  "Hazard Communication (HazCom/GHS)",
  "Indoor Heat Illness Prevention",
  "Outdoor Heat Illness Prevention",
  "Wildfire Smoke Prevention",
  "Workplace Violence Prevention"
];

// SUGGESTED TRAININGS – always shown in employee view, email ONLY if overdue
const SUGGESTED_TRAININGS = [
  "Confined Space",
  "Forklift Training",
  "Mobile Elevated Work Platform",
  "First Aid/CPR/AED",
  "Harassment & Discrimination Training",
  "Workplace Violence Property Assessment"
];

let records = [], topicMap = {}, employeeMap = {}, allTopics = new Set();

async function loadData() {
  document.getElementById('status').innerHTML = 'Fetching data...';
  try {
    const resp = await fetch(SHEET_URL + '&_=' + Date.now());
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    const text = await resp.text();
    const lines = text.split('\n').map(l => l.trim()).filter(Boolean);
    if (lines.length < 1) throw new Error('No data');
    const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
    records = lines.slice(1).map(line => {
      const vals = line.split(',').map(v => v.trim().replace(/^"|"$/g, ''));
      const rec = {};
      headers.forEach((h, i) => rec[h] = vals[i] || '');
      return rec;
    }).filter(r => r['Employee Name'] && r['Topic']);
    document.getElementById('status').innerHTML = `Loaded <strong>${records.length}</strong> records`;
    return records;
  } catch (err) {
    document.getElementById('status').innerHTML = `<span class="text-danger">Error: ${err.message}</span>`;
    return [];
  }
}

function parseTextDate(dateStr) {
  if (!dateStr) return 'N/A';
  const months = {Jan:0,Feb:1,Mar:2,Apr:3,May:4,Jun:5,Jul:6,Aug:7,Sep:8,Oct:9,Nov:10,Dec:11};
  const match = dateStr.match(/(\w{3})\s+(\d{1,2}),\s+(\d{4})/);
  if (match) {
    const [_, month, day, year] = match;
    return new Date(year, months[month], day).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
  }
  const parts = dateStr.split('/');
  if (parts.length === 3) {
    return new Date(parts[2], parts[0]-1, parts[1]).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
  }
  return dateStr || 'N/A';
}

function normalizeName(name) {
  return name?.replace(/Perira/gi, 'Pereira')
    .replace(/Silviera/gi, 'Silveira')
    .replace(/[^\w\s]/g, '')
    .trim()
    .toLowerCase()
    .replace(/\s+/g, ' ') || '';
}

function badge(r) {
  const s = r['Status'] || '';
  const days = r['Days Remaining'] || '';
  const comp = r['Completion Date'] ? parseTextDate(r['Completion Date']) : '';
  if (s === 'Completed') return `<span class="badge badge-comp">Completed${comp !== 'N/A' ? ' (' + comp + ')' : ''}</span>`;
  if (s === 'Not Due') return `<span class="badge badge-due">Not Due${days ? ' (' + days + 'd)' : ''}</span>`;
  if (s === 'Overdue') return `<span class="badge badge-over">Overdue${days ? ' (' + days + 'd)' : ''}</span>`;
  return `<span class="badge bg-secondary">${s || '—'}</span>`;
}

async function exportPDF() {
  await new Promise(r => setTimeout(r, 1000));
  try {
    const pane = document.querySelector('#detailPane .card-body');
    if (!pane) { alert('Click an employee or topic first'); return; }
    const clone = pane.cloneNode(true);

    // Add hyperlinks for PDF
    clone.querySelectorAll('td:first-child').forEach(td => {
      const topic = td.textContent.trim();
      const link = LINKS[topic];
      if (link) {
        td.innerHTML = `<a href="${link}" style="color:#007bff; text-decoration:underline;">${topic}</a>`;
      }
    });

    clone.style.padding = '20px';
    clone.style.background = '#fff';
    clone.style.border = '1px solid #ddd';
    clone.style.borderRadius = '12px';
    document.body.appendChild(clone);
    clone.style.position = 'absolute';
    clone.style.left = '-9999px';
    clone.style.width = '800px';
    const canvas = await html2canvas(clone, { scale: 2, useCORS: true });
    document.body.removeChild(clone);
    const img = canvas.toDataURL('image/png');
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'mm', 'a4');
    const w = 190;
    const h = (canvas.height * w) / canvas.width;
    pdf.addImage(img, 'PNG', 10, 10, w, h);
    const name = pane.querySelector('h4')?.textContent?.trim() || 'Report';
    pdf.save(`${name.replace(/[^a-z0-9]/gi, '_')}.pdf`);
  } catch (e) {
    console.error(e);
    alert('PDF export failed');
  }
}

function openOutlookEmail(normName) {
  const emp = employeeMap[normName];
  if (!emp) return;
  const fullName = emp.original;
  const firstName = fullName.split(' ')[0];

  const actionItems = [];

  REQUIRED_TRAININGS.forEach(topic => {
    const r = emp.records[topic];
    const link = LINKS[topic] || 'Schedule Training';

    if (r && r['Status'] === 'Overdue') {
      const trainDate = r['Training Date'] ? parseTextDate(r['Training Date']) : 'N/A';
      const exp = r['Expiration Date'] ? parseTextDate(r['Expiration Date']) : 'N/A';
      actionItems.push(`• ${topic} (REQUIRED)\n  (Training: ${trainDate} | Expires: ${exp})\n  Status: Overdue\n  Link: ${link}`);
    } else if (!r) {
      actionItems.push(`• ${topic} (REQUIRED)\n  Status: No Record / Missing\n  Link: ${link}`);
    }
  });

  SUGGESTED_TRAININGS.forEach(topic => {
    const r = emp.records[topic];
    if (r && r['Status'] === 'Overdue') {
      const link = LINKS[topic] || 'Schedule Training';
      const trainDate = r['Training Date'] ? parseTextDate(r['Training Date']) : 'N/A';
      const exp = r['Expiration Date'] ? parseTextDate(r['Expiration Date']) : 'N/A';
      actionItems.push(`• ${topic} (Suggested)\n  (Training: ${trainDate} | Expires: ${exp})\n  Status: Overdue\n  Link: ${link}`);
    }
  });

  const count = actionItems.length;
  const body = `Hi ${firstName},

You have ${count} training${count !== 1 ? 's' : ''} needing attention:

${actionItems.join('\n\n') || '• None'}

Please complete as soon as possible.

Generated: ${new Date().toLocaleString()}

LWA Training Tracker`;

  location.href = `mailto:${RECIPIENT_EMAIL}?subject=Training Action Needed: ${encodeURIComponent(fullName)}&body=${encodeURIComponent(body)}`;
}

// (buildData, renderTopics, populateEmployeeDropdown, showTopicDetail, showEmployeeDetail unchanged - no links on site, sections)

buildData();
setInterval(buildData, 600000);
</script>
</body>
</html>
