<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>LWA Employee Training Record</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body { background:#f4f6f9; font-family:system-ui, -apple-system, sans-serif; }
    .header-section {
      text-align: center;
      padding: 2.5rem 1rem 2rem;
    }
    .logo {
      max-width: 150px;
      width: 80%;
      height: auto;
      margin-bottom: 1rem;
    }
    .divider-bar {
      height: 4px;
      background-color: #3a4453; /* dark blue-grey */
      width: 200px;
      max-width: 80%;
      margin: 0 auto 1.5rem auto;
      border-radius: 2px;
    }
    .main-title {
      font-size: 1.8rem;
      font-weight: 700;
      color: #000;
      margin-bottom: 0.5rem;
    }
    .subtitle {
      color: #555;
      margin-bottom: 2rem;
      font-size: 1.1rem;
    }
    .badge-due { background:#28a745; color:#fff; font-weight:600; }
    .badge-over { background:#dc3545; color:#fff; font-weight:600; }
    .badge-comp { background:#6c757d; color:#fff; }
    .badge-norecord { background:#adb5bd; color:#fff; }
    table th {
      background:#343a40;
      color:#fff;
      font-weight:600;
    }
    .training-link {
      color:#007bff;
      text-decoration:underline;
      font-weight:600;
    }
    .card {
      box-shadow:0 4px 12px rgba(0,0,0,.07);
      border:none;
      border-radius:12px;
    }
  </style>
</head>
<body>
<div class="container-fluid">

  <!-- Header with Logo, Divider, and Title -->
  <div class="header-section">
    <img src="/aubry-logo.png" alt="LWA Logo" class="logo">
    <div class="divider-bar"></div>
    <h1 class="main-title">My LWA Training Record</h1>
    <p class="subtitle lead">Select your name below to view your current training status</p>

    <div class="d-flex justify-content-center mb-3">
      <select id="employeeSelect" class="form-select w-auto" style="min-width:300px; max-width:100%;">
        <option value="">— Select your name —</option>
      </select>
    </div>

    <div class="text-muted small" id="status">Loading training data...</div>
  </div>

  <!-- Training Details Card -->
  <div class="card mx-3 mx-md-5 mb-5 shadow d-none" id="detailPane">
    <div class="card-body p-4">
      <div class="text-center py-5">
        <p class="fs-4 text-muted">Select your name above to view your training record</p>
      </div>
    </div>
  </div>

</div>

<script>
const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRMwtFhCZCDqPeWROrxXY6ytBvitNzyVKfGyNRQ5lfTXChyrqJDwBET4tRF4ocoSsafk0O0fUwoDxj6/pub?gid=1442283748&single=true&output=csv';

const LINKS = {
  "Fall Protection": "https://www.surveymonkey.com/r/LWAFallProtectionQuiz",
  "Heat Illness Prevention": "https://www.surveymonkey.com/r/LWAIndoorHeatIllness",
  "Personal Protective Equipment": "https://www.surveymonkey.com/r/LWAPPEQuiz",
  "Silica Awareness Training": "https://www.surveymonkey.com/r/LWASilicaDustExposure",
  "Silica Dust Exposure": "https://www.surveymonkey.com/r/LWASilicaDustExposure",
  "Workplace Violence Prevention": "https://www.surveymonkey.com/r/LWAWVPP",
  "Fire Prevention and Extinguishers": "https://www.surveymonkey.com/r/LWABasicFirePreventionQuiz"
};

let employeeMap = {}, allTopics = new Set();

async function loadData() {
  document.getElementById('status').innerHTML = 'Loading training data...';
  try {
    const resp = await fetch(SHEET_URL + '&_=' + Date.now());
    if (!resp.ok) throw new Error('Failed to load');
    const text = await resp.text();
    const lines = text.split('\n').map(l => l.trim()).filter(Boolean);
    if (lines.length < 2) throw new Error('No data');
    const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
    const records = lines.slice(1).map(line => {
      const vals = line.split(',').map(v => v.trim().replace(/^"|"$/g, ''));
      const rec = {};
      headers.forEach((h, i) => rec[h] = vals[i] || '');
      return rec;
    }).filter(r => r['Employee Name'] && r['Topic']);

    employeeMap = {};
    allTopics = new Set();
    records.forEach(r => {
      const orig = r['Employee Name'];
      const topic = r['Topic'];
      const norm = normalizeName(orig);
      if (!norm || !topic) return;
      allTopics.add(topic);
      if (!employeeMap[norm]) employeeMap[norm] = { original: orig, records: {} };
      employeeMap[norm].records[topic] = r;
    });

    populateEmployeeDropdown();
    document.getElementById('status').innerHTML = '';
  } catch (err) {
    document.getElementById('status').innerHTML = '<span class="text-danger">Error loading data — please try again later</span>';
  }
}

function normalizeName(name) {
  return name?.replace(/Perira/gi, 'Pereira')
    .replace(/Silviera/gi, 'Silveira')
    .replace(/[^\w\s]/g, '')
    .trim()
    .toLowerCase()
    .replace(/\s+/g, ' ') || '';
}

function parseTextDate(dateStr) {
  if (!dateStr) return 'N/A';
  const months = {Jan:0,Feb:1,Mar:2,Apr:3,May:4,Jun:5,Jul:6,Aug:7,Sep:8,Oct:9,Nov:10,Dec:11};
  const match = dateStr.match(/(\w{3})\s+(\d{1,2}),\s+(\d{4})/);
  if (match) {
    const [_, month, day, year] = match;
    return new Date(year, months[month], day).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
  }
  const parts = dateStr.split('/');
  if (parts.length === 3) {
    return new Date(parts[2], parts[0]-1, parts[1]).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
  }
  return dateStr || 'N/A';
}

function badge(r) {
  const s = r['Status'] || '';
  const days = r['Days Remaining'] || '';
  if (s === 'Completed') return `<span class="badge badge-comp">Completed</span>`;
  if (s === 'Not Due') return `<span class="badge badge-due">Not Due${days ? ' (' + days + 'd)' : ''}</span>`;
  if (s === 'Overdue') return `<span class="badge badge-over">Overdue${days ? ' (' + days + 'd)' : ''}</span>`;
  return `<span class="badge bg-secondary text-white">${s || '—'}</span>`;
}

function populateEmployeeDropdown() {
  const sel = document.getElementById('employeeSelect');
  sel.innerHTML = '<option value="">— Select your name —</option>';
  Object.keys(employeeMap)
    .sort((a,b) => employeeMap[a].original.localeCompare(employeeMap[b].original))
    .forEach(norm => {
      const opt = document.createElement('option');
      opt.value = norm;
      opt.textContent = employeeMap[norm].original;
      sel.appendChild(opt);
    });
  sel.onchange = e => {
    if (e.target.value) {
      showEmployeeDetail(e.target.value);
    } else {
      document.getElementById('detailPane').classList.add('d-none');
    }
  };
}

function showEmployeeDetail(norm) {
  const emp = employeeMap[norm];
  if (!emp) return;
  const name = emp.original;
  let html = `<div class="card-body">
    <h3 class="text-center mb-4 fw-bold">${name}'s Training Record</h3>
    <div class="table-responsive">
      <table class="table table-hover">
        <thead>
          <tr>
            <th>Training Topic</th>
            <th>Training Date</th>
            <th>Completion Date</th>
            <th>Expires</th>
            <th>Days Left</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>`;

  Array.from(allTopics).sort((a,b) => a.localeCompare(b)).forEach(topic => {
    const r = emp.records[topic];
    let link = LINKS[topic] || Object.keys(LINKS).find(k => topic.includes(k) || k.includes(topic));
    const finalLink = link ? LINKS[link] : '';
    const cell = finalLink ? `<a href="${finalLink}" target="_blank" class="training-link">${topic}</a>` : topic;
    if (r) {
      html += `<tr>
        <td>${cell}</td>
        <td>${parseTextDate(r['Training Date'])}</td>
        <td>${parseTextDate(r['Completion Date'])}</td>
        <td>${parseTextDate(r['Expiration Date'])}</td>
        <td>${r['Days Remaining'] || '-'}</td>
        <td>${badge(r)}</td>
      </tr>`;
    } else {
      html += `<tr class="table-light">
        <td>${cell}</td>
        <td colspan="5"><span class="badge badge-norecord">No Record</span></td>
      </tr>`;
    }
  });

  html += `</tbody></table></div></div>`;
  document.getElementById('detailPane').innerHTML = html;
  document.getElementById('detailPane').classList.remove('d-none');
}

loadData();
</script>
</body>
</html>
