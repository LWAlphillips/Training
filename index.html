<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>LWA Training Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style>
    body { background:#f4f6f9; font-family:system-ui; transition:all .3s; }
    body.dark { background:#121212; color:#e0e0e0; }
    body.dark .card { background:#1e1e1e; color:#e0e0e0; border:1px solid #333; }
    body.dark table th { background:#343a40; color:#fff; }
    body.dark .table { color:#e0e0e0; }
    body.dark .table-hover tbody tr:hover { background:#2c2c2c; }
    body.dark .list-group-item { background:#2c2c2c!important; color:#e0e0e0!important; border-color:#444!important; }
    body.dark .list-group-item:hover { background:#3a3a3a!important; }
    .card { box-shadow:0 4px 12px rgba(0,0,0,.07); border:none; border-radius:12px; }
    .badge-due { background:#28a745; color:#fff; }
    .badge-over { background:#dc3545; color:#fff; }
    .badge-comp { background:#6c757d; color:#fff; }
    .badge-notify { background:#ffc107; color:#000; }
    .badge-norecord { background:#6c757d; color:#fff; }
    .list-group-item:hover { background:#e9ecef; cursor:pointer; }
    table th { background:#343a40; color:#fff; }
    .overdue-banner { background:#dc3545; color:#fff; padding:10px; border-radius:8px; margin-bottom:20px; }
    body.dark .overdue-banner { background:#bb2d3b; }
    .controls-row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; justify-content:center; }
    .control-input { width:240px!important; max-width:100%; }
    .refresh-btn { white-space:nowrap; }
    .section-header { background:#e9ecef; font-weight:bold; padding:8px 12px; border-radius:8px; margin:20px 0 10px; }
    body.dark .section-header { background:#2c2c2c; }
    @media(max-width:991px){
      .order-mobile-1 { order:1; }
      .order-mobile-2 { order:2; }
      #topicList { max-height:50vh; }
    }
    .schedule-training { color:inherit; font-weight:500; }
    body.dark .schedule-training { color:#ccc; }
  </style>
</head>
<body class="p-3">
<div class="container-fluid">
  <div id="overdueBanner" class="overdue-banner d-none">
    <strong>Overdue Alert:</strong> <span id="overdueCount"></span> trainings overdue for <span id="overdueEmps"></span> employees.
  </div>
  <div class="card mb-4"><div class="card-body text-center py-4">
    <h1 class="display-5 fw-bold text-primary">LWA Training Tracker</h1>
    <div class="status-bar text-muted" id="status">Loading...</div>
    <div class="controls-row mt-3">
      <input type="text" id="topicSearch" class="form-control form-control-sm control-input" placeholder="Search topicsâ€¦">
      <select id="employeeSelect" class="form-select form-select-sm control-input"><option value="">â€” Jump to employee â€”</option></select>
      <button class="btn btn-outline-primary btn-sm refresh-btn" onclick="buildData()">Refresh</button>
      <button class="btn btn-outline-danger btn-sm" onclick="showAllOverdue()">View All Overdue</button>
      <div class="form-check form-switch ms-2">
        <input class="form-check-input" type="checkbox" id="darkModeToggle">
        <label class="form-check-label text-muted small" for="darkModeToggle">Dark</label>
      </div>
    </div>
  </div></div>
  <div class="row">
    <div class="col-lg-8 order-mobile-1 mb-4">
      <div id="detailPane" class="card h-100">
        <div class="card-body d-flex align-items-center justify-content-center text-muted">
          <p class="mb-0 fs-5">Click a topic or employee</p>
        </div>
      </div>
    </div>
    <div class="col-lg-4 order-mobile-2 mb-4">
      <div class="card h-100">
        <div class="card-header bg-primary text-white"><strong>Training Topics</strong></div>
        <div class="card-body p-0">
          <div id="topicList" class="list-group list-group-flush" style="max-height:70vh;overflow-y:auto"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CONFIG
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRV7v_0mQWcqJI9ExD7lphRQDaHnyv65Tp_i2uDiBJOcxAJ5l6jXV1-WFFBKSU9YZErgLDkGB6nYmug/pub?output=csv';
const RECIPIENT_EMAIL = 'your-team@company.com'; // â† CHANGE TO REAL EMAIL

const LINKS = {
  "Fall Protection": "https://www.surveymonkey.com/r/LWAFallProtectionQuiz",
  "Hazard Communication (HazCom/GHS)": "https://www.surveymonkey.com/r/LWAHazCom",
  "Indoor Heat Illness Prevention": "https://www.surveymonkey.com/r/LWAIndoorHeatIllness",
  "Outdoor Heat Illness Prevention": "https://www.surveymonkey.com/r/LWAHeatIllnessQuiz",
  "Wildfire Smoke Prevention": "https://www.surveymonkey.com/r/LWAWildFireTraining",
  "Workplace Violence Prevention": "https://www.surveymonkey.com/r/LWAWVPP"
};

const ALL_TRAININGS = [
  "40-Hour Hazwoper", "Air Products- Martinez Safety Indoct", "Andeaver Martinez Site Orientation",
  "CRIS Certificate", "Certified General Electrician", "Certified Rigger and Signaler",
  "Chemical Hazard Safety", "Confined Space", "Electrical Safety Awareness",
  "Fall Protection", "Fall Protection Awareness", "Fire Prevention and Extinguishers",
  "First Aid/CPR/AED", "Forklift Training", "Hazard Communication (HazCom/GHS)",
  "Heat Illness Prevention (Indoor)", "Heat Illness Prevention (Outdoor)", "Intro to First Aid",
  "LOTO", "MEWP Fall Protection", "Machine Safe Guarding", "Mobile Elevated Work Platform",
  "NCCO Crane Operations", "Northern California RSO", "OSCA Card",
  "OSHA 10 Certificate", "OSHA 30 Certificate", "OSHA 500 Certificate", "OSHA 510 Certificate",
  "PG&E SAFE 0101 Training", "Part 46 New Miner", "Part 46 Refresher",
  "Part 48 New Miner", "Part 48 Refresher", "Personal Protective Equipment",
  "Respiratory Fit Testing", "Respiratory Medical Questionnare", "Shell Martinez Site Specific",
  "Silica Awareness Training", "Tesoro Martinez CA Site Specific", "Valley Fever Awareness",
  "Workplace Violence Prevention", "Harassment & Discrimination Training",
  "Workplace Violence Property Assessment", "Wildfire Smoke Protection"
];

const REQUIRED_TRAININGS = [
  "Fall Protection", "Hazard Communication (HazCom/GHS)",
  "Indoor Heat Illness Prevention", "Outdoor Heat Illness Prevention",
  "Wildfire Smoke Protection", "Workplace Violence Prevention"
];

const SUGGESTED_TRAININGS = [
  "Confined Space", "Forklift Training", "Mobile Elevated Work Platform",
  "First Aid/CPR/AED", "Harassment & Discrimination Training",
  "Workplace Violence Property Assessment"
];

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ADVANCED: Position-specific required trainings
// Customize this object based on your "Training Topics" sheet rules
// If a position is not listed, falls back to global REQUIRED_TRAININGS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const POSITION_REQUIREMENTS = {
  "Worker": [
    "Fall Protection",
    "Hazard Communication (HazCom/GHS)",
    "Forklift Training",
    "Outdoor Heat Illness Prevention",
    "Workplace Violence Prevention"
  ],
  "Foreman": [
    "Fall Protection",
    "Hazard Communication (HazCom/GHS)",
    "Confined Space",
    "Mobile Elevated Work Platform",
    "Indoor Heat Illness Prevention",
    "Outdoor Heat Illness Prevention",
    "Workplace Violence Prevention",
    "First Aid/CPR/AED"
  ],
  "Office": [
    "Hazard Communication (HazCom/GHS)",
    "Workplace Violence Prevention",
    "Harassment & Discrimination Training"
  ],
  // Add more positions as needed, e.g.:
  // "Manager": [...],
  // "default": REQUIRED_TRAININGS  // uncomment if you want explicit default
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// STATE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let records = [], topicMap = {}, employeeMap = {}, allTopics = new Set();
let allOverdue = [];

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// DATA LOADING
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadData() {
  document.getElementById('status').innerHTML = 'Fetching data...';
  try {
    const resp = await fetch(SHEET_URL + '&_=' + Date.now());
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    const text = await resp.text();

    const results = Papa.parse(text, {
      header: true,
      skipEmptyLines: true,
      transformHeader: h => h.trim().replace(/^"|"$/g, '')
    });

    records = results.data
      .filter(r => r['Employee Name']?.trim() && r['Topic']?.trim())
      .map(r => {
        Object.keys(r).forEach(k => {
          r[k] = (r[k] || '').trim().replace(/^"|"$/g, '');
        });
        return r;
      });

    document.getElementById('status').innerHTML = `Loaded <strong>${records.length}</strong> records`;
    return records;
  } catch (err) {
    document.getElementById('status').innerHTML = `<span class="text-danger">Error: ${err.message}</span>`;
    console.error(err);
    return [];
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// DATE PARSER
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function parseTextDate(dateStr) {
  if (!dateStr || dateStr.trim() === '') return 'N/A';

  const slashParts = dateStr.split('/');
  if (slashParts.length === 3) {
    const [m, d, y] = slashParts.map(p => parseInt(p.trim(), 10));
    if (!isNaN(m) && !isNaN(d) && !isNaN(y)) {
      let adjustedYear = y;
      if (y > 2100) adjustedYear = y - 100;
      const date = new Date(adjustedYear, m - 1, d);
      if (!isNaN(date.getTime())) {
        return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
      }
    }
  }

  const match = dateStr.match(/([A-Za-z]+)\s+(\d{1,2})[,\s]+(\d{4})/i);
  if (match) {
    const [_, monthStr, day, year] = match;
    const months = {jan:0,feb:1,mar:2,apr:3,may:4,jun:5,jul:6,aug:7,sep:8,oct:9,nov:10,dec:11};
    const monthKey = monthStr.substring(0,3).toLowerCase();
    const month = months[monthKey];
    if (month !== undefined) {
      const date = new Date(parseInt(year, 10), month, parseInt(day, 10));
      if (!isNaN(date.getTime())) {
        return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
      }
    }
  }

  return dateStr.trim();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// UTILITIES
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function normalizeName(name) {
  return name?.replace(/Perira/gi, 'Pereira')
    .replace(/Silviera/gi, 'Silveira')
    .replace(/[^\w\s]/g, '')
    .trim()
    .toLowerCase()
    .replace(/\s+/g, ' ') || '';
}

function badge(r) {
  const s = r['Status'] || '';
  const days = r['Days Remaining'] || '';
  const comp = r['Completion Date'] ? parseTextDate(r['Completion Date']) : '';
  if (s === 'Completed') return `<span class="badge badge-comp">Completed${comp !== 'N/A' ? ' (' + comp + ')' : ''}</span>`;
  if (s === 'Not Due') return `<span class="badge badge-due">Not Due${days ? ' (' + days + 'd)' : ''}</span>`;
  if (s === 'Overdue') return `<span class="badge badge-over">Overdue${days ? ' (' + days + 'd)' : ''}</span>`;
  return `<span class="badge bg-secondary">${s || 'â€”'}</span>`;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// PDF EXPORT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function exportPDF() {
  await new Promise(r => setTimeout(r, 1000));
  try {
    const pane = document.querySelector('#detailPane .card-body');
    if (!pane) { alert('Click an employee or topic first'); return; }
    const clone = pane.cloneNode(true);
    clone.querySelectorAll('td:first-child').forEach(td => {
      const topic = td.textContent.trim();
      const link = LINKS[topic];
      if (link) {
        td.innerHTML = `<a href="${link}" style="color:#007bff; text-decoration:underline;">${topic}</a>`;
      }
    });
    clone.style.padding = '20px';
    clone.style.background = '#fff';
    clone.style.border = '1px solid #ddd';
    clone.style.borderRadius = '12px';
    document.body.appendChild(clone);
    clone.style.position = 'absolute';
    clone.style.left = '-9999px';
    clone.style.width = '800px';
    const canvas = await html2canvas(clone, { scale: 2, useCORS: true });
    document.body.removeChild(clone);
    const img = canvas.toDataURL('image/png');
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'mm', 'a4');
    const w = 190;
    const h = (canvas.height * w) / canvas.width;
    pdf.addImage(img, 'PNG', 10, 10, w, h);
    const name = pane.querySelector('h4')?.textContent?.trim() || 'Report';
    pdf.save(`${name.replace(/[^a-z0-9]/gi, '_')}.pdf`);
  } catch (e) {
    console.error(e);
    alert('PDF export failed');
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// EMAIL GENERATOR (with optional Position inclusion)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openOutlookEmail(normName) {
  const emp = employeeMap[normName];
  if (!emp) return;
  const fullName = emp.original;
  const firstName = fullName.split(' ')[0];
  const position = emp.records[Object.keys(emp.records)[0]]?.['Position'] || 'N/A';

  // Get position-specific required trainings (or fallback)
  const requiredList = POSITION_REQUIREMENTS[position] || REQUIRED_TRAININGS;

  const actionItems = [];
  requiredList.forEach(topic => {
    const r = emp.records[topic];
    const link = LINKS[topic] || 'Schedule Training';
    if (r && r['Status'] === 'Overdue') {
      const trainDate = r['Training Date'] ? parseTextDate(r['Training Date']) : 'N/A';
      const exp = r['Expiration Date'] ? parseTextDate(r['Expiration Date']) : 'N/A';
      actionItems.push(`â€¢ ${topic} (REQUIRED)\n (Training: ${trainDate} | Expires: ${exp})\n Status: Overdue\n Link: ${link}`);
    } else if (!r) {
      actionItems.push(`â€¢ ${topic} (REQUIRED)\n Status: No Record / Missing\n Link: ${link}`);
    }
  });
  SUGGESTED_TRAININGS.forEach(topic => {
    const r = emp.records[topic];
    if (r && r['Status'] === 'Overdue') {
      const link = LINKS[topic] || 'Schedule Training';
      const trainDate = r['Training Date'] ? parseTextDate(r['Training Date']) : 'N/A';
      const exp = r['Expiration Date'] ? parseTextDate(r['Expiration Date']) : 'N/A';
      actionItems.push(`â€¢ ${topic} (Suggested)\n (Training: ${trainDate} | Expires: ${exp})\n Status: Overdue\n Link: ${link}`);
    }
  });
  const count = actionItems.length;
  let body = `Hi ${firstName}`;
  // Optional: include position in greeting
  // body += ` (${position})`;
  body += `,
You have ${count} training${count !== 1 ? 's' : ''} needing attention:
${actionItems.join('\n\n') || 'â€¢ None'}
Please complete as soon as possible.
Generated: ${new Date().toLocaleString()}
LWA Training Tracker`;
  location.href = `mailto:${RECIPIENT_EMAIL}?subject=Training Action Needed: ${encodeURIComponent(fullName)}&body=${encodeURIComponent(body)}`;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CORE BUILD LOGIC â€” ONLY ACTIVE EMPLOYEES
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function buildData() {
  records = await loadData();
  if (!records.length) return;

  topicMap = {};
  employeeMap = {};
  allTopics = new Set();
  allOverdue = [];
  let overdueCount = 0, overdueEmps = new Set();

  records.forEach(r => {
    if (r['Active/Inactive EE'] !== 'Active') return;

    let topic = r['Topic'];
    if (topic === "Fall Protection Awareness") topic = "Fall Protection";
    const orig = r['Employee Name'];
    const status = r['Status'] || '';
    const norm = normalizeName(orig);

    if (!norm || !topic) return;

    allTopics.add(topic);
    if (!employeeMap[norm]) employeeMap[norm] = { original: orig, records: {} };
    employeeMap[norm].records[topic] = r;

    if (!topicMap[topic]) topicMap[topic] = [];
    topicMap[topic].push({ ...r, 'Employee Name': orig });

    if (status === 'Overdue') {
      overdueCount++;
      overdueEmps.add(norm);
      allOverdue.push({
        employee: orig,
        topic: topic,
        trainingDate: r['Training Date'],
        expirationDate: r['Expiration Date'],
        daysRemaining: r['Days Remaining']
      });
    }
  });

  Object.values(employeeMap).forEach(emp => {
    REQUIRED_TRAININGS.forEach(topic => {
      if (!emp.records[topic]) {
        overdueCount++;
        overdueEmps.add(normalizeName(emp.original));
        allOverdue.push({
          employee: emp.original,
          topic: topic,
          trainingDate: '',
          expirationDate: '',
          daysRemaining: 'N/A'
        });
      }
    });
  });

  document.getElementById('overdueCount').textContent = overdueCount;
  document.getElementById('overdueEmps').textContent = overdueEmps.size;
  const banner = document.getElementById('overdueBanner');
  overdueCount ? banner.classList.remove('d-none') : banner.classList.add('d-none');

  renderTopics();
  populateEmployeeDropdown();
}

function showAllOverdue() {
  if (allOverdue.length === 0) {
    document.getElementById('detailPane').innerHTML = `<div class="card-body text-center py-5"><p class="fs-4 text-success">No overdue trainings! ðŸŽ‰</p></div>`;
    return;
  }
  let html = `<div class="card-body">
    <h3 class="text-center mb-4 fw-bold text-danger">All Overdue Trainings (${allOverdue.length})</h3>
    <div class="table-responsive">
      <table class="table table-hover">
        <thead>
          <tr>
            <th>Employee</th>
            <th>Topic</th>
            <th>Training Date</th>
            <th>Expires</th>
            <th>Days Overdue</th>
          </tr>
        </thead>
        <tbody>`;
  allOverdue.sort((a,b) => a.employee.localeCompare(b.employee) || a.topic.localeCompare(b.topic)).forEach(item => {
    const days = item.daysRemaining === 'N/A' ? 'Missing' : Math.abs(item.daysRemaining);
    html += `<tr>
      <td>${item.employee}</td>
      <td>${item.topic}</td>
      <td>${parseTextDate(item.trainingDate)}</td>
      <td>${parseTextDate(item.expirationDate)}</td>
      <td class="text-danger fw-bold">${days}</td>
    </tr>`;
  });
  html += `</tbody></table></div></div>`;
  document.getElementById('detailPane').innerHTML = html;
}

function renderTopics(filter = '') {
  const el = document.getElementById('topicList');
  el.innerHTML = '';
  ALL_TRAININGS.sort().forEach(t => {
    if (filter && !t.toLowerCase().includes(filter.toLowerCase())) return;
    const count = topicMap[t]?.length || 0;
    const item = document.createElement('a');
    item.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
    item.innerHTML = `<span class="schedule-training">${t}</span> <span class="badge bg-primary rounded-pill">${count}</span>`;
    item.onclick = () => showTopicDetail(t);
    el.appendChild(item);
  });
}

document.getElementById('topicSearch').addEventListener('input', e => renderTopics(e.target.value.trim()));

function populateEmployeeDropdown() {
  const sel = document.getElementById('employeeSelect');
  sel.innerHTML = '<option value="">â€” Jump to employee â€”</option>';
  Object.keys(employeeMap).sort((a,b) => employeeMap[a].original.localeCompare(employeeMap[b].original)).forEach(norm => {
    const emp = employeeMap[norm];
    const position = emp.records[Object.keys(emp.records)[0]]?.['Position'] || 'Unknown';
    const opt = document.createElement('option');
    opt.value = norm;
    opt.textContent = `${emp.original} (${position})`;
    sel.appendChild(opt);
  });
  sel.onchange = e => e.target.value && showEmployeeDetail(e.target.value);
}

function showTopicDetail(topic) {
  const recs = topicMap[topic] || [];
  let html = `<div class="card-body"><div class="d-flex justify-content-between"><h4>${topic}</h4><button class="btn btn-success btn-sm" onclick="exportPDF()">PDF</button></div><p class="text-muted">${recs.length} record(s)</p><div class="table-responsive"><table class="table table-sm table-hover"><thead><tr><th>Employee</th><th>Training Date</th><th>Completion Date</th><th>Expiration Date</th><th>Days Remaining</th><th>Status</th></tr></thead><tbody>`;
  recs.forEach(r => {
    const norm = normalizeName(r['Employee Name']);
    const name = employeeMap[norm]?.original || r['Employee Name'];
    html += `<tr><td><a href="javascript:void(0)" onclick="showEmployeeDetail('${norm}')">${name}</a></td><td>${parseTextDate(r['Training Date'])}</td><td>${parseTextDate(r['Completion Date'])}</td><td>${parseTextDate(r['Expiration Date'])}</td><td>${r['Days Remaining'] || '-'}</td><td>${badge(r)}</td></tr>`;
  });
  html += `</tbody></table></div></div>`;
  document.getElementById('detailPane').innerHTML = html;
}

function showEmployeeDetail(norm) {
  const emp = employeeMap[norm];
  if (!emp) return;
  const name = emp.original;
  const position = emp.records[Object.keys(emp.records)[0]]?.['Position'] || 'N/A';
  // Use position-specific required trainings
  const requiredList = POSITION_REQUIREMENTS[position] || REQUIRED_TRAININGS;
  const over = Object.entries(emp.records).filter(([,r]) => r['Status'] === 'Overdue').length;
  let html = `<div class="card-body"><div class="d-flex justify-content-between"><h4>${name}</h4><div><button class="btn btn-success btn-sm" onclick="exportPDF()">PDF</button><button class="btn btn-primary btn-sm" onclick="openOutlookEmail('${norm}')">Send Email</button></div></div>`;
  html += `<p class="text-muted mb-1">Position: <strong>${position}</strong> | Trainings grouped by category | Overdues: ${over}</p>`;
  html += `<div class="table-responsive">`;
  const addSection = (title, topics) => {
    if (topics.length === 0) return;
    html += `<div class="section-header">${title}</div><table class="table table-sm table-hover"><thead><tr><th>Topic</th><th>Training Date</th><th>Completion Date</th><th>Expiration Date</th><th>Days Remaining</th><th>Status</th></tr></thead><tbody>`;
    topics.sort().forEach(topic => {
      const r = emp.records[topic];
      if (r) {
        html += `<tr><td>${topic}</td><td>${parseTextDate(r['Training Date'])}</td><td>${parseTextDate(r['Completion Date'])}</td><td>${parseTextDate(r['Expiration Date'])}</td><td>${r['Days Remaining'] || '-'}</td><td>${badge(r)}</td></tr>`;
      } else {
        html += `<tr class="table-secondary"><td>${topic}</td><td colspan="5"><span class="badge badge-norecord">No Record</span></td></tr>`;
      }
    });
    html += `</tbody></table>`;
  };
  addSection("Required Trainings", requiredList);
  addSection("Suggested Trainings", SUGGESTED_TRAININGS);
  const additional = Object.keys(emp.records).filter(t => !requiredList.includes(t) && !SUGGESTED_TRAININGS.includes(t));
  addSection("Additional Trainings", additional);
  html += `</div></div>`;
  document.getElementById('detailPane').innerHTML = html;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// DARK MODE & INIT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('darkModeToggle').addEventListener('change', e => {
  document.body.classList.toggle('dark', e.target.checked);
  localStorage.setItem('darkMode', e.target.checked);
});

if (localStorage.getItem('darkMode') === 'true') {
  document.getElementById('darkModeToggle').checked = true;
  document.body.classList.add('dark');
}

buildData();
setInterval(buildData, 600000);
</script>
</body>
</html>
